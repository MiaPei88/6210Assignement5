---
title: "Assignment 5"
author: "Qingyuan Pei [Jump to Github](https://github.com/MiaPei88/BINF6210-Assignement5)"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction

The evolution of nuclear genes is generally slower than that of mitochondrial genes which can differ their phylogenetic trees(Lin & Danforth, 2004). Because of this, researchers often estimate phylogenetic relationship based on both of these genes for more accurate result. However, research about the discordance between different mitochondrial-gene trees are relatively limited. 

COI (Cytochrome Oxidase I) and CytB (Cytochrome b) are both mitochondrial genes that are commonly used for phylogenetic studies, species identification, and evolutionary biology in birds. Whereas, the evolutionary rates between these two genes are different across more than 300 species in avian orders: COI evolves 14% slower than CytB on average (Lavinia et al., 2016). This means choosing different marker mitochondrial genes can also make the estimated phylogenetic trees vary.  

To further explore the discordance of COI-gene trees and CytB-gene trees in a specific genera of bird, I use COI and CytB sequences data sets of *Acipenser* which are downloaded from NCBI and apply functions from packages such as "DECIPHER", "ape", and "dendextend" to make a tanglegram for examining topological congruence between the two phylogenetic trees draw from COI and CytB data sets.

### Description of Data Set

The data set I choose for this project is the DNA sequences of COI gene and CytB gene in *Acipenser* from NCBI, and this data set is obtained on December 3, 2023. Here I use rentrez package and functions in Entrez_Functions.R, a course material, to obtain the data in this R script. I also limited the sequence lengths of the two genes to exclude whole genome sequences: the range of sequence length is 500-700 for COI gene and is 600-1200 for CytB gene. 

### Code Section 1 - â€“ Data Acquisition, Exploration, Filtering, and Quality Control

Loading packages in this project.
```{r, message = FALSE}
library(tidyverse)
library(rentrez)
library(Biostrings)
library(ggtree)
library(DECIPHER)
library(ape)
library(dendextend)
```

Search for the hits of COI and CytB gene of *Acipenser*.
```{r}
NCBI_search <- entrez_search(
  db = "nuccore", 
  term = "Acipenser[ORGN] AND COI[Gene] AND 500:700[SLEN]", 
  use_history = T
  )
NCBI_search

NCBI_search1 <- entrez_search(
  db = "nuccore", 
  term = "Acipenser[ORGN] AND CytB[Gene] AND 600:1200[SLEN]", 
  use_history = T
  )
NCBI_search1
```

Using functions in Entrez_Functions.R to obtain data set from NCBI.
```{r, results = "hide"}
# Save the functions wrote in the R script to the current environment
source("Entrez_Functions.R")
# Fetch fasta files from NCBI
FetchFastaFiles(searchTerm = "Acipenser[ORGN] AND COI[Gene] AND 500:700[SLEN]", 
                seqsPerFile = 100, fastaFileName = "Acipenser_fetch_1.fasta")
FetchFastaFiles(searchTerm = "Acipenser[ORGN] AND CytB[Gene] AND 600:1200[SLEN]", 
                seqsPerFile = 100, fastaFileName = "Acipenser_fetch_2.fasta")
# Merge all fasta files and store it as a data frame 
dfNCBI_COI <- MergeFastaFiles(filePattern = "Acipenser_fetch_1.fasta.*")
dfNCBI_CytB <- MergeFastaFiles(filePattern = "Acipenser_fetch_2.fasta.*")

# Add two new columns to include the species name and sequence length of each row,
# and filter out whole genome sequences and sequences with more than 5% of Ns.
Filter1 <- function(df) {
  filtered1 <- df %>%
    mutate(Species_Name = word(Title, 2L, 3L)) %>%
    mutate(Sequence_Length = nchar(Sequence)) %>%
    mutate(Gene_Type = word(str_extract(Title, "(?i)partial|complete"))) %>%
    filter(Gene_Type == "partial") %>%
    filter(str_count(Sequence, "N") <= (0.05 * Sequence_Length))
  return(filtered1)
}
dfCOI <- Filter1(dfNCBI_COI) 
dfCytB <- Filter1(dfNCBI_CytB) 
```

Draw a histogram to see the distribution of COI sequence lengths to further decide the following data filtering steps.
```{r, fig.align = 'center', fig.cap = '**Figure 1**: '}
hist((dfCOI$Sequence_Length), 
     xlab = "Sequence Length", 
     ylab =  "Frequency", 
     main = "Distribution of COI Sequence Lengths")
```

Draw a histogram to see the distribution of CytB sequence lengths to further decide the following data filtering steps.
```{r, fig.align = 'center', fig.cap = '**Figure 2**: '}
hist((dfCytB$Sequence_Length), 
     xlab = "Sequence Length", 
     ylab =  "Frequency", 
     main = "Distribution of CytB Sequence Lengths")
```

Filter out sequences that their length are not the majority.
```{r}
dfCOI_filtered <- dfCOI %>%
  #remove sequences with length shorter than 600
  filter(Sequence_Length >= 600)

dfCytB_filtered <- dfCytB %>%
  #remove sequences that are longer and shorter than the median legnth +/- 100
  filter(Sequence_Length >= median((Sequence_Length) - 100) & 
           Sequence_Length <= median((Sequence_Length) + 100))
```

Check if the number of species between 10 to 50.
```{r}
length(unique(dfCOI$Species_Name))
length(unique(dfCytB$Species_Name))
```

Here I write a function for DNA sequence alignment and use it for COI gene sequences.
```{r, results='hide'}
# Function for sequence alignment
Alignment <- function(filtered_df) {
  df <- as.data.frame(filtered_df)
  df$nucleotides <- DNAStringSet(df$Sequence)
  # Assign the second word of the species name and the number in the title as 
  # the name of each nucleotides sequence to better see the alignment result.
  df$Alignment_id <- paste(word(df$Species_Name, 2L), 
                           word(df$Title, 1L),
                           sep = " ")
  names(df$nucleotides) <- df$Alignment_id
  alignment <- AlignSeqs(df$nucleotides)
  return(alignment)
}

dfCOI.alignment.test <- Alignment(dfCOI_filtered)
BrowseSeqs(dfCOI.alignment.test)
```

After seeing the alignment result, I decided to delete the sequences that are highly possible to be outliers as follows:
ON097839.1, MT455724.1, MK903722.1, MK903723.1, MK903724.1, MK903725.1, MK903726.1, HM902200.1, MF122058.1, MF122059.1, KC578836.1, KC578837.1, KF929572.1, KF558304.1, KC500133.1, KC578827.1, EU523886.1, EU523878.1, KM286430.1, JQ623904.1, JQ623905.1, JQ623906.1, KX145481.1, KX145032.1, KC500105.1 

Here I filtered out the sequences and then write another function for aligning sequences by their amino acid translation, in order to filter outliers that might be missed in the last step.
```{r, results='hide'}
dfCOI_filtered1 <- dfCOI_filtered %>%
  filter(!grepl('ON097839.1|MT455724.1|MK903722.1|MK903723.1|MK903724.1|MK903725.1|MK903726.1|HM902200.1|MF122058.1|MF122059.1|KC578836.1|KC578837.1|KF929572.1|KF558304.1|KC500133.1|KC578827.1|EU523886.1|EU523878.1|KM286430.1|JQ623904.1|JQ623905.1|JQ623906.1|KX145481.1|KX145032.1|KC500105.1', Title))

Translation_Alignment <- function(filtered_df) {
  df <- as.data.frame(filtered_df)
  df$nucleotides <- DNAStringSet(df$Sequence)
  df$Alignment_id <- paste(word(df$Species_Name, 2L), 
                                  word(df$Title, 1L),
                                  sep = " ")
  names(df$nucleotides) <- df$Alignment_id
  align.translation <- AlignTranslation(df$nucleotides, 
                                        # AAStringSet: Amino Acid StringSet
                                        type="AAStringSet")
  return(align.translation)
}

dfCOI.translation <- Translation_Alignment(dfCOI_filtered1)
BrowseSeqs(dfCOI.translation)
```

After seeing the Amino Acid alignment, I decide to delete sequences that are clearly different comparing to the majority of the species sequences:
ON097800.1, ON097762.1, ON097679.1, MT455123.1, KX145047.1, MG648396.1, MG648380.1, MG648371.1, MG648367.1, MG648366.1, KX145047.1, GQ328798.1, GQ328790.1, HQ960593.1, KC500103.1, FJ809729.1, FJ809728.1, FJ809727.1, FJ809726.1, FJ809725.1, FJ809722.1, HQ960593.1, HQ960592.1, HQ960591.1, HQ960590.1

Here I filter out the sequences then write another function for making a dendrogram to see the quality of data filtering.
```{r, results='hide'}
dfCOI_filtered2 <- dfCOI_filtered1 %>%
  filter(
    !grepl('ON097800.1|ON097762.1|ON097679.1|MT455123.1|KX145047.1|MG648396.1|MG648380.1|MG648371.1|MG648367.1|MG648366.1|KX145047.1|GQ328798.1|GQ328790.1|HQ960593.1|KC500103.1|FJ809729.1|FJ809728.1|FJ809727.1|FJ809726.1|FJ809725.1|FJ809722.1|HQ960593.1|HQ960592.1|HQ960591.1|HQ960590.1', Title))
```

Check the number of species for COI gene after all the data filtering steps.
```{r}
unique(dfCOI_filtered2$Species_Name)
```

DNA sequence alignment for CytB gene sequences.
```{r, results='hide'}
dfCytB.alignment.test <- Alignment(dfCytB_filtered)
BrowseSeqs(dfCytB.alignment.test)
```

After seeing the alignment result, I decided to delete the sequences in CytB group that are highly possible to be outliers: FJ974042.1, AJ249693.1, AJ249694.1, FJ974041.

Here I filtered out the sequences and then use the function "AlignTranslationTest" I write for aligning sequences by their amino acid translation, in order to filter outliers that might be missed in the last step.
```{r, results='hide'}
dfCytB_filtered1 <- dfCytB_filtered %>%
  filter(!grepl('FJ974042.1|AJ249693.1|AJ249694.1|FJ974041.1', Title))

dfCytB.translation <- Translation_Alignment(dfCytB_filtered1)

BrowseSeqs(dfCytB.translation)
```

After seeing the result of amino acid alignment of CytB group, I decide to delete the sequences that are apparently outliers comparing to the majority of the species: FJ974040.1, AJ277594.1, FJ974043.1

Here I filter out the sequences and check the number of species for CytB gene
```{r, results='hide'}
dfCytB_filtered2 <- dfCytB_filtered1 %>%
  filter(!grepl('FJ974040.1|AJ277594.1|FJ974043.1', Title))

unique(dfCytB_filtered2$Species_Name)
```

After all the data filtering steps I need to see the common species between COI and CytB groups and filter out other species that are not shared by these two marker genes.
```{r}
common_species <- intersect(dfCOI_filtered2$Species_Name, dfCytB_filtered2$Species_Name)
```

Filter out other species that are not shared by both COI and CytB group.
```{r}
dfCOI_final <- dfCOI_filtered2 %>%
  filter(Species_Name %in% common_species)

dfCytB_final <- dfCytB_filtered2 %>%
  filter(Species_Name %in% common_species)
```

I write and use the function "Dendrogram" for making dendrograms to see the quality of data filtering for COI and CytB gene sequences.
```{r}
Dendrogram <- function(filtered_df, clustering_method) {
  df <- as.data.frame(filtered_df)
  df$nucleotides <- DNAStringSet(df$Sequence)
  # I only used the first to letters of the second word in the column Species_Name
  # and the number of each sequence which is the first word in the column Title
  df$Alignment_id <- word(df$Title, 1L)
  names(df$nucleotides) <- df$Alignment_id
  df <- AlignSeqs(df$nucleotides)
  dnaBin <- as.DNAbin(df)
  # I use TN93 here as it is reliable for both COI and CytB gene
  distanceMatrix <- dist.dna(dnaBin, model = "TN93", 
                           as.matrix = TRUE, pairwise.deletion = TRUE)
  clusters <- DECIPHER::TreeLine(myDistMatrix = distanceMatrix,
                                 method = clustering_method,
                                 collapse = -1,
                                 showPlot = FALSE,
                                 type = "both",
                                 verbose = FALSE)
  return(clusters)
}
```

```{r, results='hide', fig.align = 'center', fig.cap = '**Figure 3**: Phylogenetic tree of all sequences belongs to COI gene marker'}
clusters.COI <- Dendrogram(dfCOI_final, "NJ")
COI.testtree <- as.phylo(clusters.COI[[2]])



ggtree(COI.testtree, layout="circular") + 
  geom_tiplab(size=2, aes(angle=angle), color='blue')
```

```{r, results='hide', fig.align = 'center', fig.cap = '**Figure 4**: Phylogenetic tree of all sequences belongs to CytB gene marker'}
clusters.CytB <- Dendrogram(dfCytB_final, "NJ")
CytB.testtree <- as.phylo(clusters.CytB[[2]])
ggtree(CytB.testtree, layout="circular") + 
  geom_tiplab(size=1.8, aes(angle=angle), color='purple')
```

### Main Software Tools Description

For the main analysis, I choose package "dendextend" (Galili, 2015) as the main software tool to make comparison between the two phylogenetic trees using sequences from COI and CytB markers. It is easy to understand how to use the package for making tanglegram and the code block can be tidy and short. I also considered using "phytools" but after comparing the vignettes of these two packages, I found "dendextend" can give the figure I want with less coding and better visualization. The biggest disadvantages of this tool are limited functions to change the tip labels of Neighbour Joining trees. I cannot make the labels lining up neatly as a column. Besides, I can only change the font size to see all the labels otherwise the longest label can only be shown partly. 

### Code Section 2 - Main Analysis

I write a function to find one representative sequence for each species of the two marker genes.
```{r}
FindRepSeq <- function(dendrogram, df_final) {
  # Transfer the dendrograms into phylos
  tree <- as.phylo(dendrogram)
  # Create tibbles showing the information of the trees
  treetibble <- tidytree::as_tibble(tree)
  treetibble$species <- paste(word(treetibble$label, 1L))
  # Find the median of the parent node of each species
  parent.median <- treetibble %>%
    group_by(species) %>%
    summarize(Median = round(median(parent)))
  # Choose one sequence with the median parent node number to be the representative
  rep.sequences <- treetibble %>%
    group_by(species) %>%
    filter(species != "NA") %>%
    inner_join(parent.median, by = "species") %>%
    filter(parent == Median) %>%
    sample_n(1)
  # Save the column label in rep.sequences into a new vector
  rep_sequences <- rep.sequences$label
  represent <- df_final %>%
    # Create a new column in the df_final that match the pattern off rep.sequences
    mutate(id = paste(substr(word(Species_Name, 2L),1,2), 
                      word(Title, 1L), sep = " ")) %>%
    # Filter out sequences that do not match with elements in rep_sequences
    filter(id %in% rep_sequences)
  return(represent)
}
```

Find the representative sequences of species both exist in COI and CytB group and save them into new data frames for the next step.
```{r}
COI_represent <- FindRepSeq(clusters.COI[[2]],dfCOI_final)
CytB_represent <- FindRepSeq(clusters.CytB[[2]],dfCytB_final)
```

Making new dendrograms on species level for creating the tanglegram to compare these two next.
```{r, results='hide'}
# COI representative sequences alignment and making dendrogram
dfCOI_represent <- as.data.frame(COI_represent)
dfCOI_represent$nucleotides <- DNAStringSet(dfCOI_represent$Sequence)
# I use the Species_Name here as the names for the alignment
names(dfCOI_represent$nucleotides) <- word(dfCOI_represent$Species_Name, 2L)
dfCOI_rep_alignment <- AlignSeqs(dfCOI_represent$nucleotides)
COI_dnaBin <- as.DNAbin(dfCOI_rep_alignment)
COI_distanceMatrix <- dist.dna(COI_dnaBin, model = "TN93", 
                           as.matrix = TRUE, pairwise.deletion = TRUE)
COI_rep_clusters <- DECIPHER::TreeLine(myDistMatrix = COI_distanceMatrix,
                                 method = "NJ",
                                 collapse = -1,
                                 showPlot = FALSE,
                                 type = "both",
                                 verbose = FALSE)

# CytB representative sequences alignment and making dendrogram
dfCytB_represent <- as.data.frame(CytB_represent)
dfCytB_represent$nucleotides <- DNAStringSet(dfCytB_represent$Sequence)
names(dfCytB_represent$nucleotides) <- word(dfCytB_represent$Species_Name, 2L)
dfCytB_rep_alignment <- AlignSeqs(dfCytB_represent$nucleotides)
CytB_dnaBin <- as.DNAbin(dfCytB_rep_alignment)
CytB_distanceMatrix <- dist.dna(CytB_dnaBin, model = "TN93", 
                           as.matrix = TRUE, pairwise.deletion = TRUE)
CytB_rep_clusters <- DECIPHER::TreeLine(myDistMatrix = CytB_distanceMatrix,
                                 method = "NJ",
                                 collapse = -1,
                                 showPlot = FALSE,
                                 type = "both",
                                 verbose = FALSE)
```

Making the tanglegram to compare the two trees.
```{r, fig.align = 'center', fig.cap = '**Figure 5**: This is a tanglergram Comparing the Differences between Two Phylogenetic Trees Made from COI and CytB Markers. The connecting line between two trees are based on the common subtrees of both dendrograms. Distinct branches are marked with a dashed line.'}
# Save the two dendrograms into two vectors
dend_COI <- COI_rep_clusters[[2]]
dend_CytB <- CytB_rep_clusters[[2]]
# Save the two vectors into a dendlist
dl <- dendlist(dend_COI, dend_CytB)
# Create the tanglegram
tanglegram(dl, cex_main = 1, 
           # Name the two trees with the two markers
           main_left = "COI Clustering", 
           main_right = "CytB Clustering", 
           # Change label font
           lab.cex = 0.6, 
           # Change columns width, first column(COI Clustering) as 4
           # and third column (CytB Clustering) as 6 to match the scale bars
           # for better visualization
           columns_width = c(4,3,6),
           highlight_branches_lwd = FALSE)
```

### Results and Discussion

Return to your original question. What is the answer to your question? What did you discover? Were your results as expected or not?

Briefly describe any key caveats of your study. For example, are the conclusions that can be drawn limited by sample size or any other concerns? Were there biases in data availability that could have impacted your project?

What would be the next steps for this research? What would you do next if you had more time and if you were going to develop this work into a larger project? Did your results reveal any interesting preliminary findings that would be worthy of follow-up study?

### Reflection



### References

Galili, T. (2015). dendextend: an R package for visualizing, adjusting and comparing trees of hierarchical clustering. Bioinformatics, 31(22), 3718-3720.

Lavinia, P. D., Kerr, K. C., Tubaro, P. L., Hebert, P. D., & Lijtmaer, D. A. (2016). Calibrating the molecular clock beyond cytochrome b: assessing the evolutionary rate of COI in birds. Journal of Avian Biology, 47(1), 84-91.

Lin, C. P., & Danforth, B. N. (2004). How do insect nuclear and mitochondrial gene substitution patterns differ? Insights from Bayesian analyses of combined datasets. Molecular phylogenetics and evolution, 30(3), 686-702.

LEE. (2022). R Extract first two characters from a column in a dataframe. *Stackoverflow* https://stackoverflow.com/questions/72408598/r-extract-first-two-characters-from-a-column-in-a-dataframe

Yu, G. (2022). *Data Integration, Manipulation and Visualization of Phylogenetic Trees.* CRC Press. https://yulab-smu.top/treedata-book/chapter2.html